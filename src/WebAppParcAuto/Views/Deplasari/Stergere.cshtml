@model WebAppParcAuto.Models.Deplasari.StergereViewModel

@{
    ViewData["Title"] = "Ștergere deplasare";
}

<div class="d-flex justify-content-between bg-light p-2 border-bottom border-1 border-dark-subtle">
    <div class="d-flex justify-content-start align-items-center">
        <a class="btn btn-warning" href="@Model.ReturnUrl">
            <i class="bi bi-x"></i>
            <span>Renunțare</span>
        </a>
    </div>
    @if (Model.Deplasare.Id != Guid.Empty)
    {
        <div class="d-flex justify-content-end align-items-center gap-2">
            <button type="button" class="btn btn-danger" id="btnConfirmareStergereDeplasare">
                <i class="bi bi-fuel-pump"></i>
                <span>Confirmare ștergere</span>
            </button>
        </div>
    }
</div>

@if (Model.DetaliiEroare != null)
{
    <div class="alert alert-danger m-4" role="alert">
        <i class="bi bi-exclamation-circle-fill text-danger pe-1"></i>
        <span>@Model.DetaliiEroare</span>
    </div>
}

@if (Model.ModelErrors?.Count > 0)
{
    <div class="alert alert-danger m-4" role="alert">
        @foreach (var modelError in Model.ModelErrors)
        {
            <div>
                <i class="bi bi-exclamation-circle-fill text-danger pe-1"></i>
                <span>@modelError.ErrorMessage</span>
            </div>
        }
    </div>
}


@if (Model.Deplasare.Id != Guid.Empty)
{
    <div class="mt-2 row">
        <div class="col-xl-6" id="harta" style="align-self:stretch;min-height:20rem;">
        </div>
        <div class="col-xl-6">
            <form action="/Deplasari/Stergere?returnUrl=@Model.ReturnUrl" method="POST" class="needs-validation" id="frmStergereDeplasare" novalidate autocomplete="off">
                @Html.AntiForgeryToken()
                <div>
                    <input type="hidden" asp-for="Deplasare.Id" />
                </div>
                <div class="mb-3">
                    <label asp-for="Deplasare.AngajatId" class="form-label"></label>
                    <select asp-for="Deplasare.AngajatId" class="form-control" disabled >
                        <option  value="@(Model.Deplasare?.AngajatId)">@Model.Deplasare?.Angajat?.Prenume @Model.Deplasare?.Angajat?.Nume</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label asp-for="Deplasare.MasinaId" class="form-label"></label>
                    <select asp-for="Deplasare.MasinaId" class="form-control" disabled>
                        <option  value="@(Model.Deplasare?.MasinaId)">@Model.Deplasare?.Masina?.NumarDeInmatriculare @Model.Deplasare?.Masina?.NumarDeKilometri KM</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label asp-for="Deplasare.Motiv" class="form-label"></label>
                    <input asp-for="Deplasare.Motiv" class="form-control" readonly/>
                </div>
                <div class="mb-3">
                    <label asp-for="Deplasare.Descriere" class="form-label"></label>
                    <textarea asp-for="Deplasare.Descriere" class="form-control" rows="2" readonly></textarea>
                </div>

                <div class="row">
                    <!-- Src -->
                    <div class="col-md-6">
                        <div class="mb-3 position-relative">
                            <!--
                            <i class="bi bi-box-arrow-right ps-2 text-primary fs-1_5x position-absolute" style="top:-.25rem; left:0;" ></i>
                            -->
                            <i class="bi bi-circle-fill small" style="color:var(--bs-red)"></i>
                            <label asp-for="Deplasare.SrcX" class="form-label"></label>
                            <div class="d-flex align-items-center gap-2">
                                <div>
                                    <input asp-for="Deplasare.SrcX" class="form-control mb-2" readonly title="Longitudine" />
                                    <input asp-for="Deplasare.SrcY" class="form-control" readonly title="Latitudine" />
                                </div>
                                <div>
                                    <button type="button" class="btn btn-secondary" id="btnAlegeSrcDePeHarta">
                                        <i class="bi bi-pin-map-fill"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label asp-for="Deplasare.DataPlecare" class="form-label"></label>
                            <input asp-for="Deplasare.DataPlecare" class="form-control" type="text" readonly />
                        </div>
                    </div>
                    <!-- Dst -->
                    <div class="col-md-6">
                        <div class="mb-3">
                            <i class="bi bi-circle-fill small" style="color:var(--bs-blue)"></i>
                            <label asp-for="Deplasare.DstX" class="form-label"></label>
                            <div class="d-flex align-items-center gap-2">
                                <div>
                                    <input asp-for="Deplasare.DstX" class="form-control mb-2" readonly title="Longitudine" />
                                    <input asp-for="Deplasare.DstY" class="form-control" readonly title="Latitudine" />
                                </div>
                                <div>
                                    <button type="button" class="btn btn-secondary" id="btnAlegeDstDePeHarta">
                                        <i class="bi bi-pin-map-fill"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label asp-for="Deplasare.DataSosire" class="form-label"></label>
                            <input asp-for="Deplasare.DataSosire" class="form-control" type="text" readonly/>
                        </div>
                    </div>
                </div>

                <div class="mb-3">
                    <label asp-for="Deplasare.Distanta" class="form-label"></label>
                    <input asp-for="Deplasare.Distanta" class="form-control" readonly />
                </div>
                <div class="mb-0">
                    <label asp-for="Deplasare.Observatii" class="form-label"></label>
                    <textarea asp-for="Deplasare.Observatii" class="form-control" rows="2" readonly></textarea>
                </div>
            </form>
        </div>
    </div>
}

@section Scripts {
    <script>
        'use strict'

        var page = {
            Map: {
                $: $('#harta'),
                Layers: {},
                Markers: {},
                Options: {
                    center: [45.9432, 24.9668],
                    zoom: 6,
                    zoomControl: true,
                    scrollWheelZoom: true,
                    layers: []
                }
            },

            InitializeMap: function () {
                var m = this.Map;

                m.Layers.Default = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 18,
                    opacity: 1
                });

                m.Options.layers.push(m.Layers.Default);

                m.Instance = L.map(m.$.attr("id"), m.Options);

                var pinIconSrc =  L.divIcon({
                    className: 'pinIconSrc',
                    iconSize: [30, 30],
                    iconAnchor: [15, 30],
                });

                var pinIconDst =  L.divIcon({
                    className: 'pinIconDst',
                    iconSize: [30, 30],
                    iconAnchor: [15, 30],
                });

                m.Markers.Src = L.marker([@Model.Deplasare.SrcY, @Model.Deplasare.SrcX],{
                    icon: pinIconSrc,
                    draggable: false,
                    opacity: 1,
                    title: "Plecare"
                });

                m.Markers.Src.on('drag', function(e) {
                    $("#Deplasare_SrcX").val(e.latlng.lng);
                    $("#Deplasare_SrcY").val(e.latlng.lat);
                });

                m.Markers.Dst = L.marker([@Model.Deplasare.DstY, @Model.Deplasare.DstX],{
                    icon: pinIconDst,
                    draggable: false,
                    opacity: 1,
                    title: "Sosire"
                });

                m.Markers.Dst.on('drag', function(e) {
                    $("#Deplasare_DstX").val(e.latlng.lng);
                    $("#Deplasare_DstY").val(e.latlng.lat);
                });

                m.Markers.SrcAdded = false;
                m.Markers.DstAdded = false;

                m.RoutingControlAdded = false;
            },
        };


        $(function () {
            $("#btnConfirmareStergereDeplasare").on("click", function(){
                $("#Deplasare_AngajatId, #Deplasare_MasinaId").removeAttr("disabled");
                $("#frmStergereDeplasare").submit();
            });

            page.InitializeMap();

            $("#Deplasare_AngajatId").select2({
                dropdownParent: $("#frmStergereDeplasare").parent(),
                dropdownAutoWidth: true,
                allowClear: false,
                minimumInputLength: 0,
                width: '100%',
                ajax: {
                    delay: App.Select2.AjaxRequestDelay,
                    url: "/AngajatiApi/Select2Angajati",
                    dataType: "json",
                    data: App.Select2.CustomAjaxData,
                    processResults: App.Select2.CustomAjaxProcessResults
                },
                templateSelection: function(data){
                    if (!data.id)
                        return data.text;

                    return $('<i class="bi bi-person-fill pe-1"></i><span>' + data.text + '</span>');
                },
            })
            .on("select2:select", function (e) {
                $(this).valid();
            }).on("select2:unselect", function (e) {
                $(this).valid();
            });

            $("#Deplasare_MasinaId").select2({
                dropdownParent: $("#frmStergereDeplasare").parent(),
                dropdownAutoWidth: true,
                allowClear: false,
                minimumInputLength: 0,
                width: '100%',
                ajax: {
                    delay: App.Select2.AjaxRequestDelay,
                    url: "/MasiniApi/Select2Masini",
                    dataType: "json",
                    data: App.Select2.CustomAjaxData,
                    processResults: App.Select2.CustomAjaxProcessResults
                },
                templateSelection: function(data){
                    if (!data.id)
                        return data.text;

                    return $('<i class="bi bi-car-front-fill pe-2"></i><span>' + data.text + '</span>');
                }
            })
            .on("select2:select", function (e) {
                $(this).valid();
            }).on("select2:unselect", function (e) {
                $(this).valid();
            });

            $("#btnAlegeSrcDePeHarta").on('click', function(e) {
                if(!page.Map.Markers.SrcAdded)
                {
                    page.Map.Markers.Src.addTo(page.Map.Instance);
                    page.Map.Markers.SrcAdded = true;
                }

                $("#btnAlegeSrcDePeHarta").prop("disabled",true);

                var location = page.Map.Markers.Src.getLatLng();

                page.Map.Instance.panTo(location);

                $("#Deplasare_SrcX").val(location.lng).valid();
                $("#Deplasare_SrcY").val(location.lat).valid();
            });


            $("#btnAlegeDstDePeHarta").on('click', function(e) {
                if(!page.Map.Markers.DstAdded)
                {
                    page.Map.Markers.Dst.addTo(page.Map.Instance);
                    page.Map.Markers.DstAdded = true;
                }

                $("#btnAlegeDstDePeHarta").prop("disabled",true);

                var location = page.Map.Markers.Dst.getLatLng();

                page.Map.Instance.panTo(location);

                $("#Deplasare_DstX").val(location.lng).valid();
                $("#Deplasare_DstY").val(location.lat).valid();
            });
        });
    </script>
}